name: æ„å»º Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # æ¨é€ tag æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: â˜• è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: ğŸ”§ èµ‹äºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x android/gradlew

    - name: ğŸ“¦ æ„å»º Debug APK
      run: |
        cd android
        ./gradlew assembleDebug --stacktrace

    - name: ğŸ“ è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION_NAME=$(grep "versionName" android/app/build.gradle | awk -F'"' '{print $2}')
        VERSION_CODE=$(grep "versionCode" android/app/build.gradle | awk '{print $2}')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "APK ç‰ˆæœ¬: $VERSION_NAME (Build $VERSION_CODE)"

    - name: ğŸ“ é‡å‘½å APK
      run: |
        mkdir -p release
        VERSION_NAME=${{ steps.version.outputs.version_name }}
        cp android/app/build/outputs/apk/debug/app-debug.apk release/åº”ç”¨æ•´ç†å·¥å…·-v${VERSION_NAME}.apk

    - name: ğŸ‰ ä¸Šä¼  APK (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: åº”ç”¨æ•´ç†å·¥å…·-APK-v${{ steps.version.outputs.version_name }}
        path: release/*.apk
        retention-days: 30

    - name: ğŸ“Š è·å– APK ä¿¡æ¯
      run: |
        echo "APK æ„å»ºæˆåŠŸï¼"
        ls -lh release/
        echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version_name }}"
        echo "Build: ${{ steps.version.outputs.version_code }}"
        echo "æ–‡ä»¶å¤§å°: $(du -h release/*.apk | cut -f1)"

    - name: ğŸš€ å‘å¸ƒåˆ° Release (ä»…ä¸»åˆ†æ”¯)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version_name }}
        name: åº”ç”¨æ•´ç†å·¥å…· v${{ steps.version.outputs.version_name }}
        body: |
          ## ğŸ“± åº”ç”¨æ•´ç†å·¥å…· v${{ steps.version.outputs.version_name }}
          
          **ç‰ˆæœ¬å·**: v${{ steps.version.outputs.version_name }}
          **Build**: ${{ steps.version.outputs.version_code }}
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}
          **æäº¤è€…**: ${{ github.event.head_commit.author.name }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ä¸‹æ–¹çš„ APK æ–‡ä»¶
          2. ä¼ è¾“åˆ°æ‰‹æœº
          3. ç‚¹å‡»å®‰è£…ï¼ˆå¯èƒ½éœ€è¦å…è®¸"æœªçŸ¥æ¥æº"ï¼‰
          4. æ‰“å¼€åº”ç”¨ï¼Œæˆäºˆ"æŸ¥è¯¢æ‰€æœ‰åº”ç”¨"æƒé™
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ” å®æ—¶æœç´¢æ‰‹æœºåº”ç”¨
          - ğŸ“ æ™ºèƒ½åˆ†ç±»æ•´ç† (ç¤¾äº¤/åŠå…¬/å¨±ä¹/å·¥å…·ç­‰)
          - ğŸ¨ 5ç§å“ç‰ŒUIé£æ ¼ (å°ç±³/åä¸º/OPPO/vivo/iPhone)
          - ğŸ“± ä¸€é”®æ‰“å¼€åº”ç”¨
          
          ### ğŸ”„ æ›´æ–°æ—¥å¿—
          ${{ github.event.head_commit.message }}
        files: release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
